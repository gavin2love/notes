---
title: 部署Prometheus
date: 2022-03-21 09:25:07
permalink: /pages/f56137/
---
## 前言
大多数情况, 我们使用官方提供的预编译二进制文件。查看[下载](https://prometheus.io/download)部分以获取所有可用版本的列表。

<!-- more -->

> 不过站长更喜欢用容器部署

## 使用Docker部署

### 准备工作目录
```bash
mkdir -pv /data/docker/prometheus/{data,alert_rules,job}

# 通过busybox工具箱获取nobody用户ID
docker run --rm quay.io/prometheus/busybox cat /etc/passwd
chown 65534:65534 -R /data/docker/prometheus/data
```

### 准备配置文件
::: details
cat /data/docker/prometheus/prometheus.yml
```yaml
# 全局规则
global:
  scrape_interval: 15s # 将抓取间隔设置为每 15 秒一次。 默认为每 1 分钟一次
  evaluation_interval: 15s # 每15秒评估一次规则。默认值为每1分钟
  # scrape_timeout # 每15秒评估一次规则。默认值为每1分钟

# 告警配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          # - alertmanager:9093

# 加载告警规则
rule_files:
# - /etc/prometheus/alert_rules/*.rules

# 监控任务
scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
```
:::

### 启动容器
```bash
docker run  -d  --hostname `hostname` --name prometheus \
--cpus=2 --restart=on-failure:3 \
-p 9090:9090   \
-v /data/docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro \
-v /data/docker/prometheus/alert_rules:/etc/prometheus/alert_rules \
-v /data/docker/prometheus/job:/etc/prometheus/job \
-v /data/docker/prometheus/data:/data/prometheus \
-v /etc/timezone:/etc/timezone:ro \
-v /etc/localtime:/etc/localtime:ro \
--restart=always \
prom/prometheus \
--config.file=/etc/prometheus/prometheus.yml  \
--storage.tsdb.path=/data/prometheus \
--storage.tsdb.retention.time=90d \
--web.read-timeout=7s \
--web.max-connections=512 \
--query.max-concurrency=50 \
--query.timeout=2m \
--web.enable-lifecycle
```

> storage.tsdb.retention.time  数据存储周期
> 
> web.read-timeout  请求链接的最大等待时间
> 
> web.max-connections 最大链接数
> 
> query.max-concurrency 用户并发查询连接数
> 
> query.timeout 用户并发查询超时
>
> web.enable-lifecycle 启用重载功能


# 访问
http://IP:9090/
