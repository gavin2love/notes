---
title: 监控MySQL
date: 2022-03-22 15:01:01
permalink: /pages/fe80ff/
---

<p align="center"><img src="/img/prometheus.jpg" width="auto" style="cursor: zoom-in;"></p>

## 新建数据库用户

mysqld exporter的功能是收集mysql服务器的数据, 并向外提供api接口, 用于prometheus主要获取数据。

在被监控端mysql服务器上创建账号用于mysql exporter收集使用

```sql
create user 'exporter'@'%' identified by 'xxxxxx' with max_user_connections 3;
grant process, replication client, select on *.* to 'exporter'@'%';
flush privileges;
```
## 启动监控探针
```bash
docker run -d --name mysqld-exporter \
  --restart=always \
  -p 9104:9104 \
  -e DATA_SOURCE_NAME="user:password@(hostname:3306)/" \
  prom/mysqld-exporter
```

## 服务端
进入prometheus服务端配置文件

```yaml
vim /data/docker/prometheus/prometheus.yml

scrape_configs:
  ***注意默认有一个prometheus的job任务***
  # cadvisor 容器组
  - job_name: 'mysql-exporter'
    file_sd_configs:
    - files:
      - /etc/prometheus/job/mysql.json
      refresh_interval: 1m
```
新建监控项
```yaml
cat /data/docker/prometheus/job/mysql.json

# Json格式
[
  {
    "targets": [ "172.17.80.69:9104"],
    "labels": {
      "app": "mysql-exporter",
      "nodename": "Prod-001",
      "subject": "MySQL"
    }
  },
  {
    "targets": [ "172.17.227.109:9104"],
    "labels": {
      "app": "mysql-exporter",
      "nodename": "Prod-002",
      "subject": "MySQL"
    }
  }
]
```

重载Prometheus配置
```bash
# 重启容器
docker restart prometheus
# 重载 (可能无效)
curl -XPOST http://127.0.0.1:9090/-/reload
```
  