---
title: 黑盒监控
date: 2022-03-22 16:08:43
permalink: /pages/64583d/
---
<p align="center"><img src="/img/prometheus.jpg" width="auto" style="cursor: zoom-in;"></p>

 
 # 黑盒监控
# 准备/data/docker/blackbox_exporter/blackbox.yml
```yaml
modules:
  http_2xx:
    prober: http
  http_post_2xx:
    prober: http
    http:
      method: POST
  tcp_connect:
    prober: tcp
  pop3s_banner:
    prober: tcp
    tcp:
      query_response:
      - expect: "^+OK"
      tls: true
      tls_config:
        insecure_skip_verify: false
  grpc:
    prober: grpc
    grpc:
      tls: true
      preferred_ip_protocol: "ip4"
  grpc_plain:
    prober: grpc
    grpc:
      tls: false
      service: "service1"
  ssh_banner:
    prober: tcp
    tcp:
      query_response:
      - expect: "^SSH-2.0-"
      - send: "SSH-2.0-blackbox-ssh-check"
  irc_banner:
    prober: tcp
    tcp:
      query_response:
      - send: "NICK prober"
      - send: "USER prober prober prober :prober"
      - expect: "PING :([^ ]+)"
        send: "PONG ${1}"
      - expect: "^:[^ ]+ 001"
  icmp:
    prober: icmp
```

## 运行采集探针
```bash
docker run -d \
--restart=always \
-p 9115:9115 \
--name blackbox_exporter \
-v /data/docker/blackbox_exporter/blackbox.yml:/config/blackbox.yml:ro \
prom/blackbox-exporter:latest --config.file=/config/blackbox.yml
```


## 服务端
进入prometheus服务端配置文件

```yaml
vim /data/docker/prometheus/prometheus.yml

scrape_configs:
  ***注意默认有一个prometheus的job任务***
  # HTTP探测组
  - job_name: 'blackbox_http_2xx'
    metrics_path: /probe
    params:
      module: [http_2xx]  # Look for a HTTP 200 response.
    file_sd_configs:
    - files:
      - /etc/prometheus/job/blackbox_http_2xx.json
      refresh_interval: 1m
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: 192.168.2.4:9115  # The blackbox exporter's real hostname:port.
```
新建监控项
```yaml
cat /data/docker/prometheus/job/blackbox_http_2xx.json

# Json格式
[
  {
    "targets": [ "https://www.baidu.com",
	"https://www.douyu.com"],
    "labels": {
      "nodename": "官网",
      "subject": "http_2xx"
    }
  },
  {
    "targets": [ "https://www.douyin.com"],
    "labels": {
      "nodename": "后台",
      "subject": "http_2xx"
    }
  }
]
```

重载Prometheus配置
```bash
# 重启容器
docker restart prometheus
# 重载 (可能无效)
curl -XPOST http://127.0.0.1:9090/-/reload
```
  