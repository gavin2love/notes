---
title: 监控容器
date: 2022-03-22 09:23:39
permalink: /pages/0ecdcb/
---

<p align="center"><img src="/img/prometheus.jpg" width="auto" style="cursor: zoom-in;"></p>


## 客户端（Docker版）
在客户端服务器运行以下命令，启用健康探针
```bash
docker run \
  --volume=/:/rootfs:ro \
  --volume=/var/run:/var/run:ro \
  --volume=/sys:/sys:ro \
  --volume=/var/lib/docker/:/var/lib/docker:ro \
  --volume=/dev/disk/:/dev/disk:ro \
  --publish=9101:8080 \
  --detach=true \
  --name=cadvisor \
  --privileged \
  --device=/dev/kmsg \
  google/cadvisor:latest
```

> 浏览器访问IP:9101 查看, 默认是8080端口,本文使用9101端口

## 服务端
进入prometheus服务端配置文件

vim /data/docker/prometheus/prometheus.yml
```yaml
scrape_configs:
  ***注意默认有一个prometheus的job任务***
  # cadvisor 容器组
  - job_name: 'cadvisor'
    file_sd_configs:
    - files:
      - /etc/prometheus/job/cadvisor.json
      refresh_interval: 1m
```
新建监控项
```yaml
cat /data/docker/prometheus/job/cadvisor.json

# Json格式
[
  {
    "targets": [ "172.17.80.69:9101"],
    "labels": {
      "app": "cadvisor",
      "nodename": "Prod-001",
      "subject": "容器"
    }
  },
  {
    "targets": [ "172.17.227.109:9101"],
    "labels": {
      "app": "cadvisor",
      "nodename": "Prod-002",
      "subject": "容器"
    }
  }
]
```

重载Prometheus配置
```bash
# 重启容器
docker restart prometheus
# 重载 (可能无效)
curl -XPOST http://127.0.0.1:9090/-/reload
```