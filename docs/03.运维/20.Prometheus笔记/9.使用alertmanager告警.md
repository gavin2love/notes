---
title: 使用alertmanager告警
date: 2022-03-22 16:12:40
permalink: /pages/126e65/
---

<p align="center"><img src="/img/prometheus.jpg" width="auto" style="cursor: zoom-in;"></p>

## 前言
Alertmanager 处理由 Prometheus 服务器等客户端应用程序发送的警报。它负责对它们进行重复数据删除、分组并将它们路由到正确的接收器集成，例如电子邮件、PagerDuty 或 OpsGenie。它还负责警报的静音和抑制

## 安装
准备邮件通知模板
```
vim /data/docker/alertmanager/email.tmpl

{{ define "email.to.html" }}
{{- if gt (len .Alerts.Firing) 0 -}}
{{ range .Alerts }}
=========start==========<br>
告警程序: prometheus_alert <br>
告警级别: {{ .Labels.severity }} <br>
告警类型: {{ .Labels.alertname }} <br>
告警应用: {{ .Labels.app }} <br>
告警主机: {{ .Labels.instance }} <br>
告警主题: {{ .Annotations.summary }}  <br>
告警详情: {{ .Annotations.description }} <br>
触发时间: {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }} <br>
=========end==========<br>
{{ end }}{{ end -}}
{{- if gt (len .Alerts.Resolved) 0 -}}
{{ range .Alerts }}
=========start==========<br>
告警程序: prometheus_alert <br>
告警级别: {{ .Labels.severity }} <br>
告警类型: {{ .Labels.alertname }} <br>
告警应用: {{ .Labels.app }} <br>
告警主机: {{ .Labels.instance }} <br>
告警主题: {{ .Annotations.summary }} <br>
告警详情: {{ .Annotations.description }} <br>
触发时间: {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }} <br>
恢复时间: {{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }} <br>
=========end==========<br>
{{ end }}{{ end -}}
{{- end }}
```
准备配置文件
```
vim /data/docker/alertmanager/alertmanager.yml

global:
  resolve_timeout: 5m
  # 邮件SMTP配置
  smtp_smarthost: 'smtp.163.com:465'
  smtp_from: 'xxx@163.com'
  smtp_auth_username: 'xxx@163.com'
  smtp_auth_password: 'xxxx'
  smtp_require_tls: false
# 自定义通知模板
templates:
  - '/etc/alertmanager/email.tmpl'
# route用来设置报警的分发策略
route:
  # 采用哪个标签来作为分组依据
  group_by: ['alertname']
  # 组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出
  group_wait: 10s
  # 两组告警的间隔时间
  group_interval: 10s
  # 重复告警的间隔时间，减少相同邮件的发送频率
  repeat_interval: 3h
  # 设置默认接收人
  receiver: 'email'
  routes:   # 可以指定哪些组接手哪些消息
  - receiver: 'email'
    continue: true
    group_wait: 10s
receivers:
- name: 'email'
#send_resolved: true
  email_configs:
  - to: 'hi@xxx.com'
    html: '{{ template "email.to.html" . }}'
    headers: { Subject: "Prometheus [Warning] 报警邮件" }
```

启动容器
```bash
docker run -d -p 9093:9093 \
-v /data/docker/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro \
-v /data/docker/alertmanager/email.tmpl:/etc/alertmanager/email.tmpl:ro \
--name alertmanager \
--restart=always \
prom/alertmanager:latest
```

## 服务端
进入prometheus服务端配置文件

```yaml
vim /data/docker/prometheus/prometheus.yml

# 告警配置
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 192.168.2.4:9093 # 只修改这里

# 加载告警规则
rule_files:
  - /etc/prometheus/alert_rules/*.rules

```

常用监控规则
```
vim /data/docker/prometheus/alert_rules/node.rules

# 规则在下面挑选
https://awesome-prometheus-alerts.grep.to
```

重载Prometheus配置
```bash
# 重启容器
docker restart prometheus
# 重载 (可能无效)
curl -XPOST http://127.0.0.1:9090/-/reload
```
  