---
title: maven-mvnd加速构建Java应用
date: 2022-02-3 00:10:25
permalink: /pages/8b6bc7/
---


## 介绍
该项目旨在使用 Gradle 和 Takari 中已知的技术提供更快的Maven构建。
<p align="center"><img src="/img/LC9J.png" width="auto" style="cursor: zoom-in;"></p>
<!-- more -->

## 架构概述

 - mvnd嵌入 Maven（因此无需单独安装 Maven）。
 - 实际的构建发生在一个长期存在的后台进程中，也就是守护进程。
 - 一个守护程序实例可以为来自mvnd客户端的多个连续请求提供服务。
 - mvnd客户端是使用GraalVM构建的本机可执行文件。与启动传统 JVM 相比，它启动速度更快，使用的内存更少。
 - 如果没有空闲的守护进程来服务构建请求，则可以并行生成多个守护进程。

## 这种架构带来以下优点
 - 用于运行实际构建的 JVM 不需要为每个构建重新启动。
 - 持有 Maven 插件类的类加载器被缓存在多个构建中。因此，插件 jar 只被读取和解析一次。不缓存 Maven 插件的 SNAPSHOT 版本。
 - 由 JVM 内的即时 (JIT) 编译器生成的本机代码也被保留。与普通 Maven 相比，JIT 编译花费的时间更少。在重复构建期间，JIT 优化的代码立即可用。这不仅适用于来自 Maven 插件和  - Maven Core 的代码，也适用于来自 JDK 本身的所有代码。
- 
## 附加功能
 - mvnd在现有的 Maven 之上带来以下特性：
 - 默认情况下，mvnd使用多个 CPU 内核并行构建模块。使用的核心数由公式给出Math.max(Runtime.getRuntime().availableProcessors() - 1, 1)。如果您的源代码树不支持并行构建，请传递-T1命令行以使您的构建串行。

改进的控制台输出：我们认为在股票 Maven 上并行构建的输出很难遵循。因此，我们实现了一个简化的非滚动视图，在单独的行上显示每个构建线程的状态。这是在 24 核机器上的样子：


![L8cL](/img/L8cL.gif)

## 使用maven-mvnd加速构建Java应用

```bash
# Github地址
https://github.com/apache/maven-mvnd

# 安装JDK8
yum install wget vim unzip -y
yum install java-1.8.0-openjdk java-1.8.0-openjdk-devel -y
安装 mvnd=0.7.1
wget https://oss.pealog.com/env/maven-mvnd/mvnd-0.7.1-linux-amd64.zip
unzip mvnd-0.7.1-linux-amd64.zip
mv mvnd-0.7.1-linux-amd64 /usr/local/mvnd-0.7.1

# 配置mvnd环境变量
vi /etc/profile
export MVND_HOME=/usr/local/mvnd-0.7.1
export PATH=${JAVA_HOME}/bin:${MVND_HOME}/bin:$PATH

source /etc/profile
# 配置JAVA_HOME环境(可选)
vi /etc/profile
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.322.b06-1.el7_9.x86_64
export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export PATH=$PATH:$JAVA_HOME/bin
source /etc/profile
查看环境版本
java -version && mvnd -v
```

## 编译jar包
```bash
mvnd clean package -Dmaven.test.skip=true -T 8 -B -U -pl gateway -am
 
*  clean 清理制品包
*  package 制作制品包
*  -Dmaven.test.skip=true 跳过测试
*  -T 8 使用8个并发进程
*  -B 使用非交互模式模式
*  -U 强制更新snapshot类型的插件或依赖库(否则maven一天只会更新一次snapshot依赖)
*  -pl gateway -am 指定模块构建

参数大全: https://www.cnblogs.com/zhaoyan001/p/8735196.html

mvnd具体选项
    --status列出正在运行的守护进程
    --stop杀死所有正在运行的守护进程
执行时会打印完整的选项列表mvnd --help。
```

## 配置
 可以通过属性文件提供配置。Mvnd 从以下位置读取属性文件：
- MVND_PROPERTIES_PATH使用环境变量或mvnd.propertiesPath系统变量提供的属性路径
- 本地属性路径位于[PROJECT_HOME]/.mvn/mvnd.properties
- 用户属性路径位于：[USER_HOME]/.m2/mvnd.properties
- 系统属性路径位于：[MVND_HOME]/conf/mvnd.properties
- 第一个文件中定义的属性将优先于排名较低的文件中指定的属性。
  
一些特殊属性不遵循上述机制：

- mvnd.daemonStorage：此属性定义 mvnd 存储其文件（注册表和守护程序日志）的位置。该属性只- 能在命令行中定义为系统属性
- mvnd.id：此属性在内部用于标识正在创建的守护进程
- mvnd.extClasspath: 指定 Maven 扩展类路径的内部选项
- mvnd.coreExtensions：用于指定要注册的 Maven 扩展列表的内部选项
- 有关可用属性的完整列表，请参阅 /dist/src/main/distro/conf/mvnd.properties。